<!DOCTYPE html>
<html>
<head>
  <title>SVG</title>
  <link rel="stylesheet" type="text/css" href="https://bootswatch.com/paper/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="../static/style.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
</head>
<body>

  <nav class="navbar navbar-inverse" style="margin-bottom:0;background-color:#fb6946;">
    <div class="container-fluid" style="margin:auto;display:table;">
      <div class="navbar-header" style="display:inline-block;">
        <a class="navbar-brand" style="color:#FFFFFF;font-size:30px" href="/projects">Projects</a>
      </div>   
    </div>
  </nav>

  <div >
    <div class="container-fluid" style="margin-top:10px">
      <div class="col-sm-3" style="font-size:18px;">
        <span class="glyphicon glyphicon-chevron-left"></span><a href="javascript:history.back()" style="text-decoration:none;color:#000000;">Back to Dashboard</a>
      </div>
      <div class="col-sm-6" style="font-size:18px;">
        <strong>{{ artboard }}</strong>
      </div>
      <div class="col-sm-3">
        <div style="font-size:12px">
          <input type="text" placeholder="SEARCH SCREENS" style="background-color:#fbc8bc;width:200px;
          text-align:center;border-radius:20px;"><span class="glyphicon glyphicon-search"></span>
        </div>
      </div>
    </div>
    <div class="container-fluid" style="margin-top:25px;">
      <div class="col-sm-3">
      </div>
      <div class="col-sm-6" id="image" style="overflow:auto;width:47%;height:100vh;">
        {% include url %}

        <script type="text/javascript">
          var jEscape = function(jquery) {
            jquery = jquery.replace(new RegExp("\\@", "g"), "\\@");
            jquery = jquery.replace(new RegExp("\\?", "g"), "\\?");
            jquery = jquery.replace(new RegExp("\\-", "g"), "\\-");
            jquery = jquery.replace(new RegExp("\\.", "g"), "\\.");
            jquery = jquery.replace(new RegExp("\\(", "g"), "\\(");
            jquery = jquery.replace(new RegExp("\\)", "g"), "\\)");
            jquery = jquery.replace(new RegExp("\\%", "g"), "\\%");
            jquery = jquery.replace(new RegExp("\\!", "g"), "\\!");
            jquery = jquery.replace(new RegExp("\\#", "g"), "\\#");
            jquery = jquery.replace(new RegExp("\\$", "g"), "\\$");
            jquery = jquery.replace(new RegExp("\\^", "g"), "\\^");
            jquery = jquery.replace(new RegExp("\\~", "g"), "\\~");
            jquery = jquery.replace(new RegExp("\\&", "g"), "\\&");
            jquery = jquery.replace(new RegExp("\\_", "g"), "\\_");
            jquery = jquery.replace(new RegExp("\\;", "g"), "\\;");
            jquery = jquery.replace(new RegExp("\\<", "g"), "\\<");
            jquery = jquery.replace(new RegExp("\\>", "g"), "\\>");
            return jquery;
          };

          var obj = {{ annotations|safe }};
          console.log(obj);
          var object;
          var count = obj[0];
          var full_list = '';
          var current_idq = ''
          for(var i = 0; i < obj.length; i++) {
            if (obj[i]['type'] === 'text') {
              id = obj[i]['id'];
              for (var j = i + 1; j < obj.length; j++) {
                if (obj[j]['type'] != 'tspan') {
                  break;
                }
                else {
                  document.getElementsByTagName('tspan')[count].setAttribute('parent', id);
                  count++;
                }
              }
            }
          }
          $('svg').on('mouseover', function(e){
            $(current_idq).removeAttr('style');
            var parent = '';
            outer = e.target.outerHTML;
            console.log('element: ', outer.substring(0, 30));
            outer = outer.split(' ');
            for (var i=0; i < outer.length; i++){
              if (outer[i].startsWith('parent')) {
                parent = outer[i].split("\"")[1];
              }
            }
            if (parent !== '') {
              idq = jEscape(parent);
              idq = '#' + idq;
              current_idq = idq
              $(idq).css('stroke', 'orange');
              for (var i = 0; i < obj.length; i++) {
                console.log(obj[i]['id'], parent)
                if (obj[i]['id'] === parent) {
                  displayAnnotations(obj[i]);
                  break;
                }
              }
              if (obj[i]['type'] == 'text') {
                for (var j = i + 1; j < obj.length; j++) {
                  if (obj[j]['type'] != 'tspan') {
                    full_list = ''
                    break;
                  }
                  else {
                    console.log(obj[j]);
                    object = obj[j];
                    displayAnnotations(object);
                  }
                }
              }
            }
            else {
              id = ''
              for (var i=0; i < outer.length; i++){
                if (outer[i].startsWith('id')) {
                  var id = outer[i].split('\"')[1];
                  console.log(id);
                  break;
                }
              }
              if (id !== '') {
                idq = jEscape(id)
                idq = '#' + idq;
                current_idq = idq
                $(idq).css('stroke', 'orange');
                for (var i = 0; i < obj.length; i++) {
                  if (obj[i]['id'] === id) {
                    console.log(obj[i]);
                    object = obj[i];
                    displayAnnotations(object);
                    full_list = '';
                    break;
                  }
                }
              }
            }
            function displayAnnotations(object) {
              for (var key in object) {
                if (key === 'type' || key == 'id') {
                  continue;
                }
                if (object.hasOwnProperty(key)) {
                  value = object[key];
                  key = key.bold();
                  full_list = full_list + '<li>' + key + ': ' + value + '</li>';
                }
              }
              full_list += '<br />';
              $("#annotations").html(full_list);
            }
            full_list = '';
          });

          function zoomin() {
            $("svg").width(
              $("svg").width() * 1.2
              );

            $("svg").height(
              $("svg").height() * 1.2
              );
          }

          function zoomout() {
            $("svg").width(
              $("svg").width() * 0.5
              );

            $("svg").height(
              $("svg").height() * 0.5
              );
          }

        </script>
      </div>
      <div class="col-sm-3 annotate" id="annotations" style="font-size:14px;height:650px;overflow:scroll;">
      </div>
    </div>
  </div>
  <div style="position:fixed;bottom:10px;left:10px;">
    <button class="btn" id="zoom-in" onclick="zoomin()"><span class="glyphicon glyphicon-plus"></span></button>
    <button class="btn" id="zoom-out" onclick="zoomout()"><span class="glyphicon glyphicon-minus"></span></button>
  </div>
</body>
</html>